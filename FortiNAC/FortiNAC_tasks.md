# **Задача 1**:
**Настройка Captive Portal для возможности скачивания**

### Результат:

**Cattive Portal** работает, но приходится "мудрить" так как *change of authorized* не работает

***

# **Задача 2**: 

**Получение имени пользователя при аторизации рабочей станции по dot1x или mab**

### Результат:
    
**FortiNAC** не получает имя пользователя даже при использовании **Persistent Agent**

***

# **Задача 3**:

**Возможность контролировать Multihoming подключение**

### Результат:

* Отслеживание происходит при активации пункта **Detected Multihoming**;

При подулючению второго сетевого интерфейса, в результате сканирования, конечной рабочей станции устанавливается статус **At Risk**.
![mh_log.png](/FortiNAC/img/mh_log.png)

При подключении второго сетевого интерфейса, за счет получения адреса по DHCP, меняется default gateway, в связи с чем, нет связи между Persistent Agent и FortiNAC.
В данном случае можно отследить отсуствие связи между.



    **Advanced Scan Control** не позволяет настроить действия для MultiHoming. Дополнительнные настройки сканирования работую по стаусу профиля сканирования **Scan: OS-Check**. Если сканирование пройдет, а двойного подключения не будет, то общий результат будет **True**;

***

Multihoming срабатывает:
    * при подключении второго проводного подключения;
    * при подключении второго беспроводного соединения;

Multihoming не срабатывает:
    * при подключении bluetooth-модема (использовался телефон)


# **Задача 4**:

**Возможность авторизации локальных пользователей FortiNAC**

## Локальная аутентификация (Windows Native):
!!!FortiNAC поддерживает только с использованием EAP-TTLS. Внутри должнет использоваться протоколо PAP (логин и пароль идут в открытом виде)

### Настройка локальной аутентификации

* В настройках интерфейса сетевого подключения в Windows: **Включить проверку подлинности IEEE 802.1X**;

![Netwok Options 802.1X](/FortiNAC/img/network_options.png)

* Выбрать проверку подлинности в сети: **Microsofft: EAP-TTLS**;
  
*В случае необходимости получить доступ при непрохождении процесса аутентификации выбрать Вернуться к неавторизованному сетевому доступу*

* В параметрах **Microsofft: EAP-TTLS** выбрать метод проверки подлинности, отличный от EAP: **Незашифрованный пароль (PAP)**;

![TTLS Options](/FortiNAC/img/ttls_options.png)

* * Создать пользователя в локальной базе FortiNAC (**Users & Hosts > User Accounts**):
    * *User ID:* local;
    * *Password:* password;

* Создать профиль для подключаемого устройства (**Users & Hosts > Device Profiling Rules**);

* Создать профиль для пользователя/хоста (**Policy & Objects > User/Host Profiles**):
    Выбрать следующие критерии профиля:
        
        RADIUS Ayth Type: 802.1X
            802.1X EAP Type: TTLS

![TTLS Profile](/FortiNAC/img/ttls_profile.png)

* Создать политику сетевого доступа (**Policy & Objects > Network Access**)

![TTLS Policy](/FortiNAC/img/ttls_policy.png)

    *В зависимости от требуемой политики, настраивается доступ в Isolate или Corporate сегмент*



***
### Настройка локальной аутентификации (Persistent Agent)

* Отключить на конечной рабочей стнации проверки аутентификации средствами 802.1x
* Создать пользователя в локальной базе FortiNAC (**Users & Hosts > User Accounts**):
    * *User ID:* local;
    * *Password:* password;

* Создать правило профилирования для применения MAB (**Users & Hosts > Device Profiling Rules**):
    * *Registration:* Automatic;
    * *Type:* Windows;
    * *Role:* Windows_MAB;
    * *Register as:* Device in Host View;
* Порт коммутатора должен находиться в следующих группах:
    * Force Authentiction;
    * Reset Force Default;
    * Role Based Access;
* Создать профиль для хоста (**User/Host Profiles**):
    * *Name:* Corporate_MAB;
    * *Who/What by Attribute:*
        * Host:
            * Persistent Agent: Yes;
            * Persistent Communication: Yes;
            * Role: Windows_MAB;
* Создать политику аутентификации для использования локальной базы данных (**Policy & Objects**):
    * *Name:* Local_Authentication;
    * *User/Host Profile:* Corporate_MAB;
    * *Authetication Configuration:* Local:
        * *Name:* Local;
        * *Invalid Credentials Message:* Invalid Credential;
        * *Enable Authentication:*:
            * *Time in Producton before Authentication:* 0;
            * *Time Offline before Deauthentication:* 10;
        
* Создать политики сетевого доступа (**Policy & Objects**):
    * Default_Policy(Для доступа в изолоированный VLAN и последующей регистрации при профилроовании):
        * *Name:* Default_Policy;
        * *User/Host Profile:* Global Authentication Conversion;
        * *Network Access Configuration:* Isolate
    * Only_MAB_Policy(Для доступа в корпоративный VLAN и последующей аутентификацией средствами Persistent Agent):
        * *Name:* Only_MAB_Policy;
        * *User/Host Profile:* Corporate_MAB;
        * *Network Access Configuration:* Corporate;
* В настройках Persistent Agent установить тип аутентификации Local(**System>Settings>Persistent Agent>Credential Configuration**):
    * Enable Registration
    * Register As Device
    * *Authetication Type:* Local

# **Задача 5**

**Получение запросал EAPol при подключении через RDP**

### Результат

Авторизация конечной рабочей стнации может выполняться только для пользователя или компьютера. Дополнительную аутентификацию возможно организовать средствами FortiNAC, но она будет независима от подключений по RDP. Будет осуществляться с периодичность заданной в политике аутентифиции.






# **Задача 6**

**Выяснить причину почему не добавляется FortiNAC-CA в FortiNAC-MA**

###



# **Задача 7**

**Авторизация конечной рабочей станции по сертификату с использованием AnyConnect**

    Для RDP устанавливается модуль AnyConnect NAM и осуществляется аутентификация пользователя

***
# *AnyConnect Profile Editor*

## [Client Policy]

***

### Connection Settings

**Default Connection Timeout** — Количество секунд, используемое в качестве тайм-аута подключения для созданных пользователем сетей. Значение по умолчанию – 40 секунд.

**Before User Logon** — Подключитесь к сети до того, как пользователь войдет в систему. Поддерживаемые типы входа пользователя включают проверку подлинности учетной записи пользователя (Kerberos), загрузку пользовательских объектов групповой политики и выполнение сценария входа на основе объекта групповой политики. Если вы выберете «Перед входом пользователя», вы также можете установить «Время ожидания перед тем, как разрешить пользователю вход в систему»..

**Time to wait before allowing user to Logon** —
Задает максимальное (в худшем случае) количество секунд ожидания, в течение которого диспетчер доступа к сети установит полное сетевое подключение. Если сетевое подключение не может быть установлено в течение этого времени, процесс входа в систему Windows продолжается с входом пользователя в систему. По умолчанию пять секунд

    Если диспетчер доступа к сети настроен на управление беспроводными подключениями, необходимо установить Время ожидания перед тем, как **Time to wait before allowing user to logon**, равное 30 секундам или более, поскольку для установления беспроводного подключения может потребоваться дополнительное время. Вы также должны учитывать время, необходимое для получения IP-адреса через DHCP. Если настроено два или более сетевых профиля, следует увеличить значение, чтобы охватить две или более попытки подключения.

**After User Logon** - Подключиться к сети после входа пользователя в Windows

### End-user Control

**Disable Client** — позволяет пользователям отключать и включать управление Network Access Manager проводными и беспроводными носителями с помощью пользовательского интерфейса AnyConnect. 
**Display user groups** — делает группы, созданные пользователями (созданные из CSSC 5.x), видимыми и допускающими подключение, даже если они не соответствуют группам, определенным администратором. 
**Specify a script or application to run when connected** — позволяет пользователям указать сценарий или приложение для запуска при подключении к сети.
**Auto-connect** — Автоматически подключается к сети без выбора пользователем. По умолчанию установлено автоматическое подключение

## [Authentication Policy]

***

## [Networks]

***

### Security Level

Если вы выбрали Authentication Network в разделе Security Level, появятся дополнительные панели, которые описаны ниже. Когда вы закончите настройку параметров на этих панелях, нажмите кнопку «Далее» или выберите вкладку «Тип подключения», чтобы открыть диалоговое окно «Тип сетевого подключения».

### 802.1X Settings Panel

**authPeriod (sec)** — когда начинается аутентификация, этот параметр определяет, как долго запрашивающая сторона будет ждать между сообщениями аутентификации, прежде чем истечет время ожидания, и потребует от аутентификатора повторной инициации аутентификации. 
**holdPeriod (sec)** — при сбое аутентификации этот параметр определяет, как долго запрашивающая сторона будет ждать, прежде чем можно будет предпринять еще одну попытку аутентификации. 
**startPeriod (sec)** — интервал в секундах между повторной передачей сообщений EAPOL-Start, если от аутентификатора не получен ответ на какие-либо сообщения EAPOL-Start. 
**maxStart** — количество раз, когда запрашивающая сторона инициирует аутентификацию с помощью аутентификатора, отправляя пакет протокола IEEE 801.X, данные ключа EAPOL или EAPoL-Start, прежде чем запрашивающая сторона предполагает, что аутентификатор отсутствует. Когда это происходит, запрашивающая сторона разрешает трафик данных.

    Вы можете настроить одно проводное соединение с проверкой подлинности для работы как с открытыми сетями, так и с сетями с проверкой подлинности, тщательно настроив startPeriod и maxStart таким образом, чтобы общее время, затрачиваемое на попытки инициировать проверку подлинности, было меньше, чем таймер сетевого подключения (startPeriod x maxStart таймер сетевого подключения).

### Port Authentication Exception Policy

**The Port Authentication Exception Policy** позволяет настроить поведение запрашивающей стороны IEEE 802.1X во время процесса аутентификации. Если исключения портов не включены, запрашивающая сторона продолжает свое существующее поведение и открывает порт только после успешного завершения полной настройки (или, как описано ранее в этом разделе, после того, как количество аутентификаций maxStarts инициировано без ответа от аутентификатора). 
Выберите один из следующих вариантов: 
**Allow data traffic before authentication** — разрешает трафик данных до попытки аутентификации. 
**Allow data traffic after authentication**, даже если: 
* Ошибка EAP — если выбрано, запрашивающая сторона пытается выполнить проверку подлинности. В случае сбоя аутентификации запрашивающая сторона разрешает трафик данных, несмотря на сбой аутентификации. 
* EAP завершается успешно, но управление ключами завершается сбоем. Если этот параметр выбран, запрашивающая сторона пытается согласовать ключи с сервером ключей, но разрешает трафик данных, если согласование ключей по какой-либо причине не удается. Этот параметр действителен, только если настроено управление ключами. Если управление ключами не установлено, флажок недоступен.

### Connection Types

* **Machine Connection** — имя устройства, хранящееся в Windows Active Directory, используется для авторизации. Подключение к компьютеру обычно используется, когда для подключения не требуются учетные данные пользователя. Выберите этот параметр, если конечная станция должна войти в сеть, даже если пользователь вышел из системы и учетные данные пользователя недоступны. Этот параметр обычно используется для подключения к доменам и для получения объектов групповой политики и других обновлений из сети до того, как пользователь получит доступ.
* **User Connection** — Если на панели «Политика клиента» было выбрано значение «**Before User Logon**», диспетчер доступа к сети собирает учетные данные пользователя после того, как пользователь вводит учетные данные для входа в систему на начальном экране Windows. Диспетчер доступа к сети устанавливает сетевое подключение, когда Windows запускает сеанс Windows пользователя.
  * Если на панели «Политика клиента» было выбрано значение «**After User Logon**», диспетчер доступа к сети запускает соединение после того, как пользователь входит в систему Windows.
  * Когда пользователь выходит из системы, текущее пользовательское сетевое соединение разрывается. Если профили сети машины доступны, NAM повторно подключается к сети машины.
* **Machine and User Connection** - Доступно только при настройке сети аутентификации, выбранной на панели «Уровень безопасности». Идентификатор машины, и учетные данные пользователя используются, однако машинная часть действительна только тогда, когда пользователь не вошел в систему на устройстве. Конфигурация для обеих частей одинакова, но тип аутентификации и учетные данные для подключения к компьютеру могут отличаться от типа аутентификации и учетных данных для подключения пользователя
  * Выберите этот параметр, чтобы ПК всегда оставался подключенным к сети, используя соединение с машиной, когда пользователь не вошел в систему, и используя соединение пользователя, когда пользователь вошел в систему.
  * Когда EAP-FAST настроен как метод EAP (в следующей области), поддерживается цепочка EAP. Это означает, что Network Access Manager проверяет, что машина и пользователь являются известными объектами и управляются корпорацией.
  * Когда вы выбираете тип сетевого подключения, в диалоговом окне «Сети» отображаются дополнительные вкладки, которые позволяют вам установить методы EAP и учетные данные для выбранного типа сетевого подключения.

### Authentication Page

EAP-TLS
EAP-Transport Layer Security (EAP-TLS) — это алгоритм аутентификации IEEE 802.1X EAP, основанный на протоколе TLS (RFC 2246). TLS использует взаимную аутентификацию на основе цифровых сертификатов X.509. Обмен сообщениями EAP-TLS обеспечивает взаимную аутентификацию, согласование набора шифров, обмен ключами, проверку между клиентом и сервером аутентификации, а также ключевой материал, который можно использовать для шифрования трафика.
В приведенном ниже списке представлены основные причины, по которым клиентские сертификаты EAP-TLS могут обеспечивать строгую аутентификацию для проводных и беспроводных подключений:

* Аутентификация происходит автоматически, обычно без вмешательства пользователя.
* Зависимости от пароля пользователя не существует.
* Цифровые сертификаты обеспечивают надежную защиту аутентификации.
* Обмен сообщениями защищен шифрованием с открытым ключом.
* Сертификаты не подвержены атакам по словарю.
* Результатом процесса аутентификации является взаимно определенный ключ для шифрования и подписи данных.

    EAP-TLS содержит две опции:
    - Проверить сертификат сервера — включает проверку сертификата сервера.
    - Включить быстрое повторное подключение. Включает возобновление сеанса TLS, что позволяет значительно ускорить повторную аутентификацию с помощью сокращенного рукопожатия TLS, если данные сеанса TLS сохраняются как на клиенте, так и на сервере.
    Примечание

    !Параметр «Отключить при использовании смарт-карты» недоступен для проверки подлинности подключения к компьютеру.